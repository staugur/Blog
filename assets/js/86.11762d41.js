(window.webpackJsonp=window.webpackJsonp||[]).push([[86],{383:function(s,t,n){"use strict";n.r(t);var a=n(0),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("加密代理功能的实现，越过封锁限制，访问被墙的国外站点，比如Google、FaceBook。")]),s._v(" "),n("p",[s._v("用户访问配置了代理服务的浏览器（可使用扩展实现自动切换代理，代理服务即国内stunnel监听地址），\n国内stunnel开启加密连接国外stunnel再连接国外squid真实代理服务器请求实际网站并返回数据，\n如下架构图：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://static.saintic.com/picbed/staugur/2020/12/08/stunnel-squid-arch.png",alt:"stunnel-squid-arch.png"}})]),s._v(" "),n("p",[s._v("按照上述图，也就是需要两台服务器，不过可以简化，国内stunnel可以直接在用户个人笔记本/台式机\n启动，因为stunnel程序支持windows、macOS、Linux。")]),s._v(" "),n("p",[s._v("以下步骤适用于CentOS/RHEL系统。")]),s._v(" "),n("h2",{attrs:{id:"一、国外的服务器安装squid和stunnel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、国外的服务器安装squid和stunnel"}},[s._v("#")]),s._v(" 一、国外的服务器安装squid和stunnel")]),s._v(" "),n("h3",{attrs:{id:"_1-安装squid"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装squid"}},[s._v("#")]),s._v(" 1.安装Squid")]),s._v(" "),n("p",[n("code",[s._v("yum -y install squid")])]),s._v(" "),n("p",[s._v("也不用修改配置，因为单单squid代理根本翻不了墙，所以需要一个加密的通道，stunnel，而stunnel只需要连接localhost的squid端口即可。")]),s._v(" "),n("h3",{attrs:{id:"_2-安装stunnel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装stunnel"}},[s._v("#")]),s._v(" 2.安装Stunnel")]),s._v(" "),n("p",[n("code",[s._v("yum -y install stunnel openssl openssl-devel")])]),s._v(" "),n("p",[s._v("生成pem证书：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/stunnel/\nopenssl req -new -x509 -days "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("365")]),s._v(" -nodes -out stunnel.pem -keyout stunnel.pem\nopenssl gendh "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" stunnel.pem "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#警告：这行不是必须的")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" -s /sbin/nologin -M stunnel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("修改/etc/stunnel/stunnel.conf(stunnel默认的配置文件)，复制以下内容：")]),s._v(" "),n("div",{staticClass:"language-ini line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ini"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("cert")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /etc/stunnel/stunnel.pem")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CAfile")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /etc/stunnel/stunnel.pem")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("socket")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" l:TCP_NODELAY=1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("socket")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" r:TCP_NODELAY=1")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;;chroot = /var/run/stunnel")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("pid")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /tmp/stunnel.pid")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("verify")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 3")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; CApath = certs")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; CRLpath = crls")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; CRLfile = crls.pem")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("setuid")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" stunnel")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("setgid")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" stunnel")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; client=yes")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("compression")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" zlib")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; taskbar = no")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("delay")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" no")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; failover = rr")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; failover = prio")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("sslVersion")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" TLSv1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";;; fips=no")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("debug")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 7")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("syslog")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" no")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("output")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" stunnel.log")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token selector"}},[s._v("[sproxy]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("accept")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 34567")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("connect")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 127.0.0.1:3128")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[s._v("accept = 34567 是 stunned要监听的端口号")]),s._v(" "),n("p",[s._v("connect = 127.0.0.1:3128 是Squid的监听地址和端口")]),s._v(" "),n("p",[s._v("在参考的原文中 fips=no 是未被注释的，但在我机器上此参数导致不能启动，所以我才注释掉，如遇到无法启动，可去掉注释。")]),s._v(" "),n("h3",{attrs:{id:"_3-启动squid和stunnel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-启动squid和stunnel"}},[s._v("#")]),s._v(" 3.启动squid和stunnel")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" squid start\nstunnel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("如果没有错误输出表示配置成功，并可以使用以下命令查看是否启动成功。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" aux "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -E "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"squid|stunnel"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("netstat")]),s._v(" -an "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" “LISTEN” "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" -E "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"squid|stunnel"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h2",{attrs:{id:"二、国内服务器安装stunnel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、国内服务器安装stunnel"}},[s._v("#")]),s._v(" 二、国内服务器安装stunnel")]),s._v(" "),n("h3",{attrs:{id:"_1-安装stunnel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装stunnel"}},[s._v("#")]),s._v(" 1. 安装stunnel")]),s._v(" "),n("p",[n("code",[s._v("yum -y install stunnel openssl-devel")])]),s._v(" "),n("h3",{attrs:{id:"_2-修改配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改配置文件"}},[s._v("#")]),s._v(" 2. 修改配置文件")]),s._v(" "),n("p",[s._v("将国外服务器生成的stunnel.pem复制过来，唯一的不同在于配置文件中 "),n("strong",[s._v("sproxy")]),s._v(" 那段，\n编辑stunnel.conf：")]),s._v(" "),n("div",{staticClass:"language-ini line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-ini"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("cert")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /etc/stunnel/stunnel.pem")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("socket")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" l:TCP_NODELAY=1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("socket")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" r:TCP_NODELAY=1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("verify")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CAfile")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" /etc/stunnel/stunnel.pem")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("client")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v("yes")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("compression")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" zlib")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("ciphers")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" AES256-SHA")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("delay")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" no")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("failover")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" prio")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("sslVersion")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" TLSv1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v(";; fips = no")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token selector"}},[s._v("[sproxy]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("accept")]),s._v("  "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 0.0.0.0:7071")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("connect")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" 国外服务器IP:34567")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("解释说明：\naccept = 0.0.0.0:7071 即是用户要设置的端口，\nconnect = 国外服务器IP:34567 ，即国外服务器IP和Stunnel监听的端口号")]),s._v(" "),n("h3",{attrs:{id:"_3-启动stunnel服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-启动stunnel服务"}},[s._v("#")]),s._v(" 3. 启动stunnel服务")]),s._v(" "),n("p",[n("code",[s._v("stunnel")])]),s._v(" "),n("p",[s._v("此时用户连接到国内服务器7071作为代理就可以访问一些被墙的网站。")]),s._v(" "),n("p",[s._v("在国内没有服务器，可以在本地安装的一个Stunnel，用来加解密，所以没有国内服务也不要紧。")]),s._v(" "),n("p",[s._v("去stunnel官网下载一个windows版的客户端，将上面国内服务器的stunnel.conf配置文件和国外服务器stunnel.pem证书放到stunnel安装目录/config/下启动即可。")]),s._v(" "),n("Ads"),s._v(" "),n("Utterances")],1)}),[],!1,null,null,null);t.default=e.exports}}]);