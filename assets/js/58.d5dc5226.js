(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{538:function(s,n,a){"use strict";a.r(n);var e=a(4),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("运维中，我们有时候想要记录服务器上谁登录了、干了什么，前者可以使用之前的"),a("a",{attrs:{href:"https://blog.saintic.com/blog/234.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("ssh登录报警"),a("OutboundLink")],1),s._v("这篇文章，后者则可以参考本文。")]),s._v(" "),a("p",[s._v("此功能利用的是history命令、PROMPT_COMMAND环境变量、/etc/profile.d/扩展全局环境变量，Linux中的PROMPT_COMMAND会记录下出现提示符前面的命令，利用这个特性可以实现记录所有用户的操作记录。")]),s._v(" "),a("p",[a("strong",[s._v("环境：")])]),s._v(" "),a("p",[s._v("centos6、7，要求安装iproute(yum install iproute)")]),s._v(" "),a("p",[a("strong",[s._v("原理：")])]),s._v(" "),a("p",[s._v("自定义history和PROMPT_COMMAND相关环境变量，放到/etc/profile.d/中令全局生效，记录所有用户的命令操作。")]),s._v(" "),a("p",[a("strong",[s._v("步骤：")])]),s._v(" "),a("ol",[a("li",[s._v("将以下代码保存到/etc/profile.d/cmdhistLog.sh")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# bash cmd audit\n# root touch $HISTFILE && chmod a+w $HISTFILE, yum install iproute\nreadonly HISTSIZE=10000\nreadonly HISTFILESIZE=10000\nreadonly HISTFILE=/tmp/XingkaOpsCmdHist.log\nreadonly SERVER_IPS=$(/usr/sbin/ip a | grep inet | grep -v inet6 | grep -v 127 | sed \'s/^[ \\t]*//g\' | cut -d \' \' -f2 | awk -F \'/\' \'{print $1}\' | xargs | sed \'s/\\s/,/g\')\nreadonly PROMPT_COMMAND=\'{ \\\nif [ -z "$OLD_PWD" ];then\n    export OLD_PWD=$PWD;\nfi;\nif [ ! -z "$LAST_CMD" ] && [ "$(history 1)" != "$LAST_CMD" ]; then\n    msg=$(history 1 | { read x y; echo $y; });echo [$(date +"%Y-%m-%d %H:%M:%S")] [\\($USER\\) $(who am i |awk "{print \\$1\\" \\"\\$2\\" \\"\\$NF}" | sed -e "s/[()]//g")] [$(hostname)@$SERVER_IPS] "$msg" >> $HISTFILE;\nfi;\nexport LAST_CMD="$(history 1)";\nexport OLD_PWD=$PWD; }\'\nshopt -s histappend\nexport HISTSIZE HISTFILESIZE HISTFILE PROMPT_COMMAND\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("上述保存后，重新登录的终端即可生效，建议手动创建下日志文件，并需要授予所有人可写权限")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# $HISTFILE改为实际日志文件路径\ntouch $HISTFILE && chmod a+w $HISTFILE\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("使用python清洗日志，筛选出有效的命令数据并上报给运维平台、数据库等")])]),s._v(" "),a("p",[a("strong",[s._v("# PS: 脚本可能需要根据实际情况自行修改。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#!/usr/bin/python\n# coding: utf8\n# Author: taochengwei\n# Email: taochengwei@starokay.com\n# Date: 2018-12-11\n# Docs: Command the audit log report\n\nimport os\nimport re\nimport sys\nimport stat\nimport json\nimport urllib\nimport urllib2\nimport traceback\nreload(sys)\nsys.setdefaultencoding('utf-8')\n\nlog = os.getenv('HISTFILE', '/tmp/XingkaOpsCmdHist.log')\npat = re.compile(r'^(\\[.*\\])\\s(\\[.*\\])\\s(\\[.*\\])\\s(.*)$')\nif not os.path.isfile(log):\n    with open(log, \"w\") as f:\n        f.write(\"\")\n    os.chmod(log, stat.S_IWUSR+stat.S_IRUSR+stat.S_IRGRP+stat.S_IWGRP+stat.S_IWOTH)\n\n\ndef post(url, data, token=None):\n    \"\"\" POST请求 \"\"\"\n    if isinstance(data, dict):\n        data = urllib.urlencode(data)  # 将字典以url形式编码\n    headers = {'AccessToken': token} if token else {}\n    headers.update({\"User-Agent\": \"Mozilla/5.0 (X11; CentOS; Linux i686; rv:7.0.1406) Gecko/20100101 OpsRequestBot/0.1\", \"Content-Type\": \"application/json\"})\n    request = urllib2.Request(url, data=data, headers=headers)\n    response = urllib2.urlopen(request)\n    response = response.read()\n    try:\n        data = json.loads(response)\n    except Exception, e:\n        traceback.print_exc()\n        data = response\n    return data\n\n\nif __name__ == \"__main__\" and log and os.path.isfile(log):\n    access_token = \"\"\n    # read log\n    with open(log, 'rb') as f:\n        data = f.read()\n    os.chmod(log, stat.S_IWUSR+stat.S_IRUSR+stat.S_IRGRP+stat.S_IWGRP+stat.S_IWOTH)\n    # set post data pool\n    # pool 是筛选后的有效命令数据，是一个列表，可以上报到运维平台或写入数据库中\n    pool = []\n    for cmd in data.split(\"\\n\"):\n        if pat.match(cmd):\n            cmd = [i for i in pat.split(cmd) if i]\n            if cmd and isinstance(cmd, (list, tuple)) and len(cmd) == 4:\n                try:\n                    # Time to execute the command\n                    ctime = cmd[0].lstrip('[').rstrip(']')\n                    # Switch user, real login user, terminal for pts or tty, client ip\n                    suser, luser, terminal, clientIp = cmd[1].lstrip('[').rstrip(']').split()\n                    suser = suser.replace('(', '').replace(')', '')\n                    # the server hostname and all ip\n                    hostname, serverIps = cmd[2].lstrip('[').rstrip(']').split('@')\n                    # real bash command\n                    command = cmd[3]\n                except Exception, e:\n                    traceback.print_exc()\n                    print cmd\n                else:\n                    pool.append(dict(ctime=ctime, suser=suser, luser=luser, terminal=terminal, clientIp=clientIp, hostname=hostname, serverIps=serverIps, command=command))\n    # post data with pool\n    res = post(\"接收上报的运维平台接口地址\", json.dumps(pool), access_token)\n    if res[\"code\"] == 0:\n        with open(log, \"w\") as f:\n            f.write(\"\")\n    print(res)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("后端处理")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    # 这是后端运维平台的接口路由函数，它接收命令审计数据，并用异步任务写入数据库\n    def serverCmdHist(self, data):\n        """服务器历史命令记录"""\n        res = dict(code=1, msg=None)\n        if data and isinstance(data, (list, tuple)):\n            # 需要进一步筛选有效条目\n            pool = []\n            for log in data:\n                if log and isinstance(log, dict) and \\\n                        "ctime" in log and \\\n                        "serverIps" in log and \\\n                        "hostname" in log and \\\n                        "terminal" in log and \\\n                        "command" in log and \\\n                        "suser" in log and \\\n                        "luser" in log and \\\n                        "clientIp" in log:\n                    # check log params\n                    try:\n                        if not user_pat.match(log["luser"]) or not ip_check(log["clientIp"]) or not log["hostname"] or not log["command"]:\n                            raise\n                        datetime_to_timestamp(log["ctime"])\n                    except:\n                        pass\n                    else:\n                        # 此处生成一条有效命令唯一标识，避免误提交审计日志时重复写入数据库\n                        log.update(oci=md5("%s-%s-%s-%s-%s" %(log["hostname"], log["ctime"], log["luser"], log["suser"], log["command"])))\n                        pool.append(log)\n            # 此处pool中的命令记录都应该是有效的，放到异步任务中写入到mysql\n            self.asyncQueueHigh.enqueue_call(func=ServerCmdHist2MySQL, args=(pool,), timeout=3600)\n            res.update(code=0)\n        else:\n            res.update(msg="data error")\n        return res\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br")])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("数据库表结构")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("CREATE TABLE `servercmdhist` (\n  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,\n  `oci` char(32) NOT NULL COMMENT '命令唯一标识',\n  `hostname` varchar(150) NOT NULL COMMENT '主机名',\n  `serverIps` varchar(255) DEFAULT NULL COMMENT '主机ip',\n  `ctime` char(19) NOT NULL COMMENT '命令执行的时间',\n  `luser` varchar(32) NOT NULL COMMENT '实际登录的用户',\n  `suser` varchar(32) DEFAULT NULL COMMENT '实际用户切换后的用户',\n  `terminal` varchar(50) DEFAULT NULL COMMENT '登录终端类型',\n  `clientIp` varchar(15) NOT NULL COMMENT '登录来源ip',\n  `command` varchar(10000) NOT NULL COMMENT '执行的命令',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `oci` (`oci`),\n  KEY `hostname` (`hostname`)\n) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);