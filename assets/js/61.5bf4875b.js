(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{541:function(s,n,e){"use strict";e.r(n);var a=e(4),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("本站早先启用了HTTPS+HTTP2，现在也支持TLSv1.3，更多了解TLSv1.3，可以查看"),e("a",{attrs:{href:"https://wiki.openssl.org/index.php/TLS1.3",target:"_blank",rel:"noopener noreferrer"}},[s._v("WIKI"),e("OutboundLink")],1),s._v("。")]),s._v(" "),e("p",[s._v("这篇文章仅记录过程。")]),s._v(" "),e("p",[e("strong",[s._v("环境：")])]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v("1. CentOS7.4\n\n2. 存在yum安装的nginx，版本是1.14；系统的openssl版本是1.0.2k（这俩是之前启用H2时升级的）\n")])])]),e("p",[e("strong",[s._v("启用TLSv.13思路：")])]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v("核心就是让nginx和openssl支持。目前 Nginx 1.13 以上的版本支持 TLS 1.3 版本，而 OpenSSL 1.1.1 版本支持 TLS 1.3 版本。\n\n所以版本要大于上面两个即可。\n\n虽然nginx版本到了，但是由于yum安装的，又不升级系统本身的openssl，所以只能卸载再编译安装nginx。\n")])])]),e("p",[e("strong",[s._v("步骤：")])]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v("升级时间是2019-02-27，当天nginx最新版本是nginx-1.15.9，openssl最新版本是1.1.1b\n\n1. 下载、编译、安装\n")])])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("cd /usr/local/src/\nyum install -y wget jemalloc jemalloc-devel\nwget https://www.openssl.org/source/openssl-1.1.1b.tar.gz\nwget http://nginx.org/download/nginx-1.15.9.tar.gz\ntar zxf openssl-1.1.1b.tar.gz\ntar zxf nginx-1.15.9.tar.gz\ncd nginx-1.15.9\n./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_v2_module --with-http_gzip_static_module --with-http_sub_module --with-stream --with-stream_ssl_module --with-openssl=../openssl-1.1.1b --with-openssl-opt='enable-tls1_3 enable-weak-ssl-ciphers' --with-ld-opt=-ljemalloc\nmake\nmake install\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v('2. 卸载原有nginx并更新新的nginx配置\n\n不需要yum安装的nginx了，卸载就行，省的回头不小心乱了，同时将配置文件迁移到新的中，要修改使其支持TLSv1.3。\n\n修改的地方：\n\n    2.1 ssl on，去掉，改为listen 443 ssl http2，[为什么？](https://nginx.org/en/CHANGES)nginx1.15.0更改的。不然会触发如下警告：\n\n        nginx: \\[warn\\] the "ssl" directive is deprecated, use the "listen ... ssl" directive instead in /usr/local/nginx/conf/xx.conf:7\n\n    2.2 协议和加密套件的配置\\(个人示例\\)：\n\n        ssl\\_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;\n\n        ssl\\_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:\\!MD5;\n\n    2.3 **注意！所有支持HTTPS的配置文件都要更新协议和加密套件使其支持TLSv1.3，否则单个不生效！**\n\n        我碰到了这个问题，后来查到[这篇文章](https://blog.rj-bai.com/post/145.html)，修改了所有的解决问题。\n\n3. 验证\n\n    3.1 可以到<https://myssl.com/>验证HTTPS的网站\n\n    3.2 Chrome、Firefox等现代浏览器支持了TLSv1.3，我用的chrome72.0.3626.119，F12打开开发者工具-Security，如图：\n')])])]),e("p",[e("img",{attrs:{src:"https://static.saintic.com/EauDouce/blog/201902281030464757.png",alt:"企业微信截图_20190228102911"}})]),s._v(" "),e("p",[s._v("附录：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[s._v("1. 给编译安装的nginx一个系统服务脚本：[centos7](https://www.nginx.com/resources/wiki/start/topics/examples/systemd/)，[centos6或5](https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/)\n\n2. nginx ssl配置完整示例：\n")])])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('server {\n    listen 80;\n    listen 443 ssl http2;\n    server_name xxx;\n    charset utf-8;\n    access_log /var/log/nginx/access.log main;\n\n    ssl_certificate certs/full_chain.pem;\n    ssl_certificate_key certs/private.key;\n    #OCSP Stapling开启,OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高TLS握手速度\n    ssl_stapling on;\n    #OCSP Stapling验证开启\n    ssl_stapling_verify on;\n    #用于查询OCSP服务器的DNS\n    resolver 8.8.8.8 114.114.114.114 valid=300s;\n    #查询域名超时时间\n    resolver_timeout 5s;\n    #SSL优化配置\n    #Session Cache，将Session缓存到服务器，这可能会占用更多的服务器资源\n    ssl_session_cache builtin:1000 shared:SSL:10m;\n    #开启浏览器的Session Ticket缓存\n    ssl_session_tickets on;\n    #SSL session过期时间\n    ssl_session_timeout  10m;\n    #只启用 TLS 系列协议\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;\n    #加密套件,这里用了CloudFlare\'s Internet facing SSL cipher configuration\n    ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;\n    #由服务器协商最佳的加密算法\n    ssl_prefer_server_ciphers on;\n    #开启HSTS，并设置有效期为9460800秒（9个月），包括子域名(根据情况可删掉)：includeSubdomains，预加载到浏览器缓存(根据情况可删掉)\n    add_header Strict-Transport-Security "max-age=15768001; preload";\n\n    #禁止被嵌入框架\n    #add_header X-Frame-Options DENY;\n    #防止在IE9、Chrome和Safari中的MIME类型混淆攻击\n    add_header X-Content-Type-Options nosniff;\n    #处理静态资源:\n    location ~ ^\\/static\\/.*$ {\n        root /xxx;\n        access_log off;\n    }\n    location / {\n       proxy_pass http://127.0.0.1:110;\n       proxy_set_header Host $host;\n       proxy_set_header X-Real-IP $remote_addr;\n       proxy_set_header X-Forwarded-Proto $scheme;\n       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);