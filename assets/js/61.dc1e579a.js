(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{541:function(s,n,t){"use strict";t.r(n);var e=t(4),a=Object(e.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("本站早先启用了HTTPS+HTTP2，现在也支持TLSv1.3，更多了解TLSv1.3，可以查看"),t("a",{attrs:{href:"https://wiki.openssl.org/index.php/TLS1.3",target:"_blank",rel:"noopener noreferrer"}},[s._v("WIKI"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("p",[s._v("这篇文章仅记录过程。")]),s._v(" "),t("p",[t("strong",[s._v("环境：")])]),s._v(" "),t("ol",[t("li",[t("p",[s._v("CentOS7.4")])]),s._v(" "),t("li",[t("p",[s._v("存在yum安装的nginx，版本是1.14；系统的openssl版本是1.0.2k（这俩是之前启用H2时升级的）")])])]),s._v(" "),t("p",[t("strong",[s._v("启用TLSv.13思路：")])]),s._v(" "),t("p",[s._v("核心就是让nginx和openssl支持。目前 Nginx 1.13 以上的版本支持 TLS 1.3 版本，而 OpenSSL 1.1.1 版本支持 TLS 1.3 版本。")]),s._v(" "),t("p",[s._v("所以版本要大于上面两个即可。")]),s._v(" "),t("p",[s._v("虽然nginx版本到了，但是由于yum安装的，又不升级系统本身的openssl，所以只能卸载再编译安装nginx。")]),s._v(" "),t("p",[t("strong",[s._v("步骤：")])]),s._v(" "),t("p",[s._v("升级时间是2019-02-27，当天nginx最新版本是nginx-1.15.9，openssl最新版本是1.1.1b")]),s._v(" "),t("ol",[t("li",[s._v("下载、编译、安装")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/src/\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" jemalloc jemalloc-devel\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://www.openssl.org/source/openssl-1.1.1b.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://nginx.org/download/nginx-1.15.9.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxf openssl-1.1.1b.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxf nginx-1.15.9.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" nginx-1.15.9\n./configure --prefix"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_v2_module --with-http_gzip_static_module --with-http_sub_module --with-stream --with-stream_ssl_module --with-openssl"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/openssl-1.1.1b --with-openssl-opt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'enable-tls1_3 enable-weak-ssl-ciphers'")]),s._v(" --with-ld-opt"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-ljemalloc\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("卸载原有nginx并更新新的nginx配置")])]),s._v(" "),t("p",[s._v("不需要yum安装的nginx了，卸载就行，省的回头不小心乱了，同时将配置文件迁移到新的中，要修改使其支持TLSv1.3。")]),s._v(" "),t("p",[s._v("修改的地方：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("ssl on，去掉，改为listen 443 ssl http2，"),t("a",{attrs:{href:"https://nginx.org/en/CHANGES",target:"_blank",rel:"noopener noreferrer"}},[s._v("为什么？"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("nginx1.15.0更改的。不然会触发如下警告：")]),s._v(" "),t("p",[s._v('nginx: [warn] the "ssl" directive is deprecated, use the "listen ... ssl" directive instead in /usr/local/nginx/conf/xx.conf:7')])]),s._v(" "),t("li",[t("p",[s._v("协议和加密套件的配置(个人示例)：")]),s._v(" "),t("p",[s._v("ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;")]),s._v(" "),t("p",[s._v("ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;")])]),s._v(" "),t("li",[t("p",[t("strong",[s._v("注意！所有支持HTTPS的配置文件都要更新协议和加密套件使其支持TLSv1.3，否则单个不生效！")])]),s._v(" "),t("p",[s._v("我碰到了这个问题，后来查到"),t("a",{attrs:{href:"https://blog.rj-bai.com/post/145.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("这篇文章"),t("OutboundLink")],1),s._v("，修改了所有的解决问题。")])])]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("验证")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可以到"),t("a",{attrs:{href:"https://myssl.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://myssl.com/"),t("OutboundLink")],1),s._v("验证HTTPS的网站")])]),s._v(" "),t("li",[t("p",[s._v("Chrome、Firefox等现代浏览器支持了TLSv1.3，我用的chrome72.0.3626.119，F12打开开发者工具-Security，如图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://static.saintic.com/EauDouce/blog/201902281030464757.png",alt:"企业微信截图_20190228102911"}})])])]),s._v(" "),t("p",[s._v("附录：")]),s._v(" "),t("ul",[t("li",[t("ol",[t("li",[s._v("给编译安装的nginx一个系统服务脚本："),t("a",{attrs:{href:"https://www.nginx.com/resources/wiki/start/topics/examples/systemd/",target:"_blank",rel:"noopener noreferrer"}},[s._v("centos7"),t("OutboundLink")],1),s._v("，"),t("a",{attrs:{href:"https://www.nginx.com/resources/wiki/start/topics/examples/redhatnginxinit/",target:"_blank",rel:"noopener noreferrer"}},[s._v("centos6或5"),t("OutboundLink")],1)])])]),s._v(" "),t("li",[t("ol",{attrs:{start:"2"}},[t("li",[s._v("nginx ssl配置完整示例：")])])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('server {\n    listen 80;\n    listen 443 ssl http2;\n    server_name xxx;\n    charset utf-8;\n    access_log /var/log/nginx/access.log main;\n\n    ssl_certificate certs/full_chain.pem;\n    ssl_certificate_key certs/private.key;\n    #OCSP Stapling开启,OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高TLS握手速度\n    ssl_stapling on;\n    #OCSP Stapling验证开启\n    ssl_stapling_verify on;\n    #用于查询OCSP服务器的DNS\n    resolver 8.8.8.8 114.114.114.114 valid=300s;\n    #查询域名超时时间\n    resolver_timeout 5s;\n    #SSL优化配置\n    #Session Cache，将Session缓存到服务器，这可能会占用更多的服务器资源\n    ssl_session_cache builtin:1000 shared:SSL:10m;\n    #开启浏览器的Session Ticket缓存\n    ssl_session_tickets on;\n    #SSL session过期时间\n    ssl_session_timeout  10m;\n    #只启用 TLS 系列协议\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;\n    #加密套件,这里用了CloudFlare\'s Internet facing SSL cipher configuration\n    ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;\n    #由服务器协商最佳的加密算法\n    ssl_prefer_server_ciphers on;\n    #开启HSTS，并设置有效期为9460800秒（9个月），包括子域名(根据情况可删掉)：includeSubdomains，预加载到浏览器缓存(根据情况可删掉)\n    add_header Strict-Transport-Security "max-age=15768001; preload";\n\n    #禁止被嵌入框架\n    #add_header X-Frame-Options DENY;\n    #防止在IE9、Chrome和Safari中的MIME类型混淆攻击\n    add_header X-Content-Type-Options nosniff;\n    #处理静态资源:\n    location ~ ^\\/static\\/.*$ {\n        root /xxx;\n        access_log off;\n    }\n    location / {\n       proxy_pass http://127.0.0.1:110;\n       proxy_set_header Host $host;\n       proxy_set_header X-Real-IP $remote_addr;\n       proxy_set_header X-Forwarded-Proto $scheme;\n       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br")])])])}),[],!1,null,null,null);n.default=a.exports}}]);