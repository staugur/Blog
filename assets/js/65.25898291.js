(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{545:function(s,n,e){"use strict";e.r(n);var a=e(4),r=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"php7"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#php7"}},[s._v("#")]),s._v(" PHP7")]),s._v(" "),e("p",[s._v("2015年正式发版php7.0，随后每年都有发布新版，截止本文时，php7.4已经出了，不过官网上稳定版还是7.3。")]),s._v(" "),e("p",[s._v("PHP7是趋势，不过我之前只是简单了解php语法，这次为了接入tdi，再捡起来索性放弃5.x，而且php7.1都快超过安全支持期了，7.2、7.3才比较靠谱。")]),s._v(" "),e("h2",{attrs:{id:"tdi-php"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tdi-php"}},[s._v("#")]),s._v(" Tdi-php")]),s._v(" "),e("p",[s._v("这个"),e("a",{attrs:{href:"https://github.com/staugur/tdi-php",target:"_blank",rel:"noopener noreferrer"}},[s._v("小应用"),e("OutboundLink")],1),s._v("是用来下载大量图片的，基于php7，开发版本php7.2，但是并没有用其新特性，所以支持7.0+，另外测试过的操作系统也只有CentOS、Ubuntu。")]),s._v(" "),e("p",[s._v("本文即记录开发这个小应用时的一些工具，本人菜鸟，文中有误万请指点！")]),s._v(" "),e("h4",{attrs:{id:"_1-系统负载、磁盘、内存等"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-系统负载、磁盘、内存等"}},[s._v("#")]),s._v(" 1. 系统负载、磁盘、内存等")]),s._v(" "),e("p",[s._v("这些函数是从几个探针程序中剥离，并添加一些其他的，不过数据来源于系统运行时产生的/proc文件，Windows并不适用。")]),s._v(" "),e("p",[e("strong",[s._v("1.1 获取系统内存使用率")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("//返回内存使用率百分比，类型float\nfunction memRate()\n{\n    $res = array();\n    // MEMORY\n    if (false === ($str = @file('/proc/meminfo'))) {\n        return false;\n    }\n    $str = implode('', $str);\n    preg_match_all('/MemTotal\\s{0,}\\:+\\s{0,}([\\d\\.]+).+?MemFree\\s{0,}\\:+\\s{0,}([\\d\\.]+).+?Cached\\s{0,}\\:+\\s{0,}([\\d\\.]+).+?SwapTotal\\s{0,}\\:+\\s{0,}([\\d\\.]+).+?SwapFree\\s{0,}\\:+\\s{0,}([\\d\\.]+)/s', $str, $buf);\n    preg_match_all('/Buffers\\s{0,}\\:+\\s{0,}([\\d\\.]+)/s', $str, $buffers);\n    $res['memTotal'] = round($buf[1][0]*1024, 2);\n    $res['memFree'] = round($buf[2][0]*1024, 2);\n    $res['memBuffers'] = round($buffers[1][0]*1024, 2);\n    $res['memCached'] = round($buf[3][0]*1024, 2);\n    $res['memUsed'] = $res['memTotal']-$res['memFree'];\n    $res['memPercent'] = (floatval($res['memTotal'])!=0)?round($res['memUsed']/$res['memTotal']*100, 2):0;\n    return $res['memPercent'];\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("p",[e("strong",[s._v("1.2 获取系统负载")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("//返回五分钟负载，类型float\nfunction loadStat()\n{\n    // LOAD AVG\n    if (false === ($str = @file('/proc/loadavg'))) {\n        return false;\n    }\n    $load = explode(' ', implode('', $str));\n    return floatval($load[1]);\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("1.3 获取目录所在磁盘的使用率")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("//返回path目录所在磁盘的使用率百分比，类型int；传参ret不为percent时，返回目录所在磁盘的数据，类型array\nfunction diskRate(string $path=null, string $ret='percent')\n{\n    //硬盘\n    $checkPath = $path ? $path : __DIR__;\n    $dt = round(@disk_total_space($checkPath), 3); //总\n    $df = round(@disk_free_space($checkPath), 3); //可用\n    $du = $dt-$df; //已用\n    $hdPercent = (floatval($dt)!=0)?round($du/$dt*100, 2):0;\n    return $ret === 'percent' ? $hdPercent : array('total'=>$dt, 'available'=>$df, 'used'=>$du, 'percent'=>$hdPercent);\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h4",{attrs:{id:"_2-统计目录中所有文件总字节-不包括子目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-统计目录中所有文件总字节-不包括子目录"}},[s._v("#")]),s._v(" 2. 统计目录中所有文件总字节(不包括子目录)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('//用来统计一个目录的大小，返回字节，exclude允许排除统计某些后缀，比如$exclude = [\'zip\',\'txt\']\nfunction getDirSize(string $dir, array $exclude=array())\n{\n    $sizeResult = 0;\n    $handle = opendir($dir);\n    while (false!==($FolderOrFile = readdir($handle))) {\n        if ($FolderOrFile != "." && $FolderOrFile != "..") {\n            $f = "$dir/$FolderOrFile";\n            if (is_file($f) && !in_array(pathinfo($f, PATHINFO_EXTENSION), $exclude)) {\n                $sizeResult += filesize($f);\n            }\n        }\n    }\n    closedir($handle);\n    return $sizeResult;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("h4",{attrs:{id:"_3-彻底删除目录-文件和子目录-等同rm-rf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-彻底删除目录-文件和子目录-等同rm-rf"}},[s._v("#")]),s._v(" 3. 彻底删除目录(文件和子目录，等同rm -rf)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("function delDir(string $directory)\n{\n    if (file_exists($directory)) {//判断目录是否存在，如果不存在rmdir()函数会出错\n        if ($dir_handle=@opendir($directory)) {//打开目录返回目录资源，并判断是否成功\n            while ($filename=readdir($dir_handle)) {//遍历目录，读出目录中的文件或文件夹\n                if ($filename!='.' && $filename!='..') {//一定要排除两个特殊的目录\n                    $subFile=$directory.\"/\".$filename;//将目录下的文件与当前目录相连\n                    if (is_dir($subFile)) {//如果是目录条件则成了\n                        delDir($subFile);//递归调用自己删除子目录\n                    }\n                    if (is_file($subFile)) {//如果是文件条件则成立\n                        unlink($subFile);//直接删除这个文件\n                    }\n                }\n            }\n            closedir($dir_handle);//关闭目录资源\n            rmdir($directory);//删除空目录\n        }\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("h4",{attrs:{id:"_4-zip压缩目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-zip压缩目录"}},[s._v("#")]),s._v(" 4. Zip压缩目录")]),s._v(" "),e("p",[s._v("注释里有参考，整理并改进了一下，其效果是：压缩某个目录所有文件，但不包含子目录，也可以排除压缩某些后缀的文件。")]),s._v(" "),e("p",[s._v("不过注意：要压缩的文件（压缩时文件名放入待删除数组to_be_unlinked ）在完成压缩后会删除，如果不想删除，参考下面代码第50行（"),e("code",[s._v("foreach ($to_be_unlinked as $v)")]),s._v("）的注释提示。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/*\n    // 生成zip压缩文件的函数，参考：https://blog.csdn.net/zhao_teng/article/details/84941828\n    @param $dir             string 需要压缩的文件夹名\n    @param $filename     string 压缩后的zip文件名  包括zip后缀\n    @param $exclude      array   不需要压缩的文件后缀，后缀不包含点\n    @return 成功时返回压缩文件的绝对路径，否则返回false\n*/\nclass MakeZip\n{\n    public function zip(string $dir, string $filename, array $exclude=array())\n    {\n        if (!is_dir($dir)) {\n            die('can not exists dir '.$dir);\n        }\n\n        //判断是否为zip后缀\n        if (pathinfo($filename, PATHINFO_EXTENSION) != 'zip') {\n            die('only Support zip files');\n        }\n\n        $dir = str_replace('\\\\', '/', $dir);\n        $filename = str_replace('\\\\', '/', $filename);\n        $filename = iconv('utf-8', 'gb2312', $filename);\n        if (is_file($filename)) {\n            die('the zip file '.$filename.' has exists !');\n        }\n\n        //目录中的所有文件\n        $files = array();\n        $this->getfiles($dir, $files);\n        $files = $this->array_iconv($files);\n        if (empty($files)) {\n            die(' the dir is empty');\n        }\n\n        //执行压缩\n        $zip = new ZipArchive();\n        $res = $zip->open($filename, ZipArchive::CREATE);\n        if ($res === true) {\n            foreach ($files as $v) {\n                // 设定在压缩包内文件名\n                $_in_zip_filename = str_replace($dir.'/', '', $v);\n                // 依据文件后缀判断是否排除(即不压缩)\n                if (is_file($v) && !in_array(pathinfo($_in_zip_filename, PATHINFO_EXTENSION), $exclude)) {\n                    $zip->addFile($v, $_in_zip_filename);\n                    $to_be_unlinked[] = $v;\n                }\n            }\n            $zip->close();\n            //由于zip需要close后才执行压缩操作，所以只能在这里删除压缩的文件，如果不想删除，请注释下面三行\n            foreach ($to_be_unlinked as $v) {\n                unlink($v);\n            }\n            return realpath($filename);\n        } else {\n            return false;\n        }\n    }\n\n    //定义图片字符集\n    protected function array_iconv($data, $in_charset='GBK', $out_charset='UTF-8')\n    {\n        if (!is_array($data)) {\n            $output = iconv($in_charset, $out_charset, $data);\n        } elseif (count($data) === count($data, 1)) {//判断是否是二维数组\n            foreach ($data as $key => $value) {\n                $output[$key] = iconv($in_charset, $out_charset, $value);\n            }\n        } else {\n            eval_r('$output = ' . iconv($in_charset, $out_charset, var_export($data, true)) . ';');\n        }\n        return $output;\n    }\n\n    //获取目录中文件赋值给$files\n    private function getfiles($dir, &$files=array())\n    {\n        if (!is_dir($dir)) {\n            return false;\n        }\n        if (substr($dir, -1)=='/') {\n            $dir = substr($dir, 0, strlen($dir)-1);\n        }\n        $_files = scandir($dir);\n        foreach ($_files as $v) {\n            if ($v != '.' && $v!='..') {\n                if (is_file($dir.'/'.$v)) {\n                    $files[] = $dir.'/'.$v;\n                }\n            }\n        }\n        return $files;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br")])]),e("p",[s._v("示例：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<?php\nrequire_once 'tool.php';\n//压缩test_dir目录，生成test.zip压缩文件，但压缩时不会压缩目录中.zip结尾的文件。\n$zip = new MakeZip;\n$zipfilepath = $zip->zip('test_dir', 'test.zip', ['zip']);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h4",{attrs:{id:"_5-简单地日志记录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-简单地日志记录"}},[s._v("#")]),s._v(" 5. 简单地日志记录")]),s._v(" "),e("p",[s._v("由于是个小应用，但是也有些信息需要记录，所以直接使用file_put_contents写入到文件中，利用debug_backtrace获取写日志的文件和行号。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/*\n    * 日志类\n    * 当文件超过指定大小则备份日志文件并重新生成新的日志文件\n    * 使用时，直接调用三个静态方法，info、error、debug\n*/\nclass Log\n{\n    //日志文件名，放到了logs目录了\n    private static $filename = __DIR__.'/logs/sys.log';\n    //最大文件大小10M\n    private static $maxsize = 10240000;\n\n    //写入日志\n    protected function _log($msg, $level='INFO')\n    {\n        if (!is_dir(__DIR__.'/logs')) {\n            mkdir(__DIR__.'/logs');\n        }\n        $filename = self::$filename;\n        // 来源文件与行号，回溯2条\n        $trace = debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, $limit=2);\n        $file = $trace[1]['file'];\n        $line = $trace[1]['line'];\n        // 格式化消息\n        if (is_array($msg)) {\n            $msg = json_encode($msg);\n        }\n        $content = sprintf(\"[ %s ] %s %s:%s %s\\n\", $level, date('Y-m-d H:i:s', time()), str_replace(__DIR__.'/', '', $file), $line, $msg);\n\n        //如果日志文件超过了指定大小则备份日志文件\n        if (file_exists($filename) && (abs(filesize($filename)) > self::$maxsize)) {\n            $newfilename = dirname($filename).'/'.time().'-'.basename($filename);\n            rename($filename, $newfilename);\n        }\n\n        //往日志文件内容后面追加日志内容\n        file_put_contents($filename, $content, FILE_APPEND);\n    }\n\n    public static function debug($msg)\n    {\n        $log = new self();\n        $log->_log($msg, 'DEBUG');\n    }\n\n    public static function info($msg)\n    {\n        $log = new self();\n        $log->_log($msg, 'INFO');\n    }\n\n    public static function error($msg)\n    {\n        $log = new self();\n        $log->_log($msg, 'ERROR');\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br")])]),e("p",[s._v("示例：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# cat test.php\n<?php\nrequire_once 'tool.php';\nLog::info('info');\nLog::error('error');\nLog::debug('debug');\n\n# cat logs/sys.log\n[ INFO ] 2019-06-19 17:50:30 test.php:5 info\n[ ERROR ] 2019-06-19 17:50:31 test.php:6 error\n[ DEBUG ] 2019-06-19 17:50:31 test.php:7 debug\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h4",{attrs:{id:"_6-curl的封装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-curl的封装"}},[s._v("#")]),s._v(" 6. curl的封装")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/*\n    //使用curl扩展发起http请求，支持https，可以发起get、post请求\n    @param $url  string: 请求地址\n    @param $data array:  如果存在，则为post请求\n    @param $timeout int: 超时秒数\n    @param $parse_json boolean: 是否将响应进行json解码\n    @return array\n*/\nfunction request(string $url, array $data=null, int $timeout=10, bool $parse_json=true)\n{\n    $useragent = 'Tdi-PHP/v1';\n    $curl = curl_init();\n    curl_setopt($curl, CURLOPT_URL, $url);\n    curl_setopt($curl, CURLOPT_HEADER, 1); //设置返回响应头\n    curl_setopt($curl, CURLOPT_USERAGENT, $useragent);\n    curl_setopt($curl, CURLOPT_TIMEOUT, $timeout);\n    curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);\n    curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);\n    curl_setopt($curl, CURLOPT_FOLLOWLOCATION, 1);\n    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);\n    if (!empty($data)) {\n        curl_setopt($curl, CURLOPT_POST, 1);\n        curl_setopt($curl, CURLOPT_POSTFIELDS, $data);\n    }\n    $output = curl_exec($curl);\n    if (curl_getinfo($curl, CURLINFO_HTTP_CODE) === 200) {\n        list($header, $body) = explode(\"\\r\\n\\r\\n\", $output, 2);\n    }\n    curl_close($curl);\n    return $parse_json ? json_decode($body, true) : $body;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h4",{attrs:{id:"_7-php-resque的使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-php-resque的使用"}},[s._v("#")]),s._v(" 7. php-resque的使用")]),s._v(" "),e("p",[s._v("前面有说，本文就是在写一个小应用时的使用记录，觉得有用的几个函数、类分享出来，而这个应用在下载大量图片时，采用了后台队列的方式，将下载功能独立一个类，并采用php-resque这个轻量级队列程序将下载放到队列中，另行处理。")]),s._v(" "),e("p",[s._v("php-resque是resque（ruby）的php实现，原作者仓库是"),e("a",{attrs:{href:"https://github.com/chrisboulton/php-resque",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/chrisboulton/php-resque"),e("OutboundLink")],1),s._v(", 但是我用composer安装这个仓库代码时无法运行，少了些东西；原仓库已经几年没更新了，作者将项目交给了resque社区维护，仓库地址是："),e("a",{attrs:{href:"https://github.com/resque/php-resque",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/resque/php-resque"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("以下步骤会运行一个简单的示例，但不是官方给的demo，可以参考示例集成到你的项目中。")]),s._v(" "),e("p",[s._v("此示例假设，项目目录是demo，redis密码abc，端口默认6379，使用0库，其DSN-style连接串是redis://:"),e("a",{attrs:{href:"mailto:abc@127.0.0"}},[s._v("abc@127.0.0")]),s._v(".1")]),s._v(" "),e("p",[s._v("7.1 安装")]),s._v(" "),e("p",[s._v("使用命令："),e("code",[s._v("composer require resque/php-resque")])]),s._v(" "),e("p",[s._v("解释说明：composer是php的包管理命令，如果没有安装，参考"),e("a",{attrs:{href:"https://getcomposer.org/download/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),e("OutboundLink")],1),s._v("，也可以用操作系统的包管理器安装，比如Ubuntu用"),e("code",[s._v("apt-get install composer")]),s._v("，RHEL/CentOS系用"),e("code",[s._v("yum install composer")])]),s._v(" "),e("p",[s._v("7.2 创建文件")]),s._v(" "),e("p",[s._v("上面安装了resque/php-resque后，会在当前demo目录下生成composer.json、composer.lock文件和vender目录：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# tree -L 3\n.\n├── composer.json\n├── composer.lock\n└── vendor\n    ├── autoload.php\n    ├── bin\n    │   └── resque -> ../resque/php-resque/bin/resque\n    ├── colinmollenhour\n    │   └── credis\n    ├── composer\n    │   ├── autoload_classmap.php\n    │   ├── autoload_namespaces.php\n    │   ├── autoload_psr4.php\n    │   ├── autoload_real.php\n    │   ├── autoload_static.php\n    │   ├── ClassLoader.php\n    │   ├── installed.json\n    │   └── LICENSE\n    ├── psr\n    │   └── log\n    └── resque\n        └── php-resque\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])]),e("p",[s._v("关于composer生成的这些文件，可以只保留"),e("code",[s._v("composer.json")]),s._v("，也可以全都要，更多了解请自行Google，现在了解下php-resque。")]),s._v(" "),e("p",[e("strong",[s._v("在Resque中，一个后台任务被抽象为由三种角色共同完成：")])]),s._v(" "),e("ul",[e("li",[e("p",[s._v("Job | 任务 ： 一个Job就是一个需要在后台完成的任务，比如发邮件、下载图片，就可以抽象为一个Job。在Resque中一个Job就是一个Class。")])]),s._v(" "),e("li",[e("p",[s._v("Queue | 队列 ： 在Resque中，队列则是由Redis实现的。Resque还提供了一个简单的队列管理器，可以实现将Job插入/取出队列等功能。")])]),s._v(" "),e("li",[e("p",[s._v("Worker | 执行者 ： 负责从队列中取出Job并执行，可以以守护进程的方式运行在后台。")])])]),s._v(" "),e("p",[e("strong",[s._v("其流程如下：")])]),s._v(" "),e("ol",[e("li",[e("p",[s._v("将一个后台任务编写为一个独立的Class，这个Class就是一个Job。")])]),s._v(" "),e("li",[e("p",[s._v("在需要使用后台程序的地方，系统将Job Class的名称以及所需参数放入队列。")])]),s._v(" "),e("li",[e("p",[s._v("以命令行方式开启一个Worker，并通过参数指定Worker所需要处理的队列。")])]),s._v(" "),e("li",[e("p",[s._v("Worker作为守护进程运行，并且定时检查队列。")])]),s._v(" "),e("li",[e("p",[s._v("当队列中有Job时，Worker取出Job并运行，即实例化Job Class并执行Class中的方法。")])])]),s._v(" "),e("p",[s._v("php-resque是resque的php实现，所以角色和流程是一致的，不过php-resque没有web的队列管理器等。")]),s._v(" "),e("p",[e("strong",[s._v("7.2.1 编写任务类文件：job.php")])]),s._v(" "),e("p",[s._v("任务类要实现"),e("code",[s._v("perform")]),s._v("方法，参考"),e("a",{attrs:{href:"https://github.com/resque/php-resque#defining-jobs",title:"文档",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),e("OutboundLink")],1),s._v("，这个方法所需参数可以用"),e("code",[s._v("$this->args['参数']")]),s._v("获取。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<?php\n\nclass TestJob\n{\n    public function perform()\n    {\n        $name = $this->args['name'];\n        echo 'Hello '.$name;\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("7.2.2 编写调用任务代码：index.php")])]),s._v(" "),e("p",[s._v("上面job.php中的TestJob类，在项目中不会直接调用，项目代码中需要主动往队列Queue中扔任务，参考"),e("a",{attrs:{href:"https://github.com/resque/php-resque#queueing-jobs",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("以下模拟项目代码index.php：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("<?php\n\n// 执行成功，将任务放到队列中\nrequire_once './vendor/autoload.php';\n// 设置resque的redis连接信息\nResque::setBackend('redis://:abc@127.0.0.1');\n$args = array(\n    'name'=> 'saintic.com'\n);\n// 入列\nResque::enqueue('default', 'TestJob', $args);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("注意入列这行：default是队列名，可以设置为其他名称；TestJob是上面job.php任务类的类名；$args就是任务类"),e("code",[s._v("perform")]),s._v("方法所需参数。")]),s._v(" "),e("p",[e("strong",[s._v("7.2.3 启动Worker进程等待处理任务")])]),s._v(" "),e("p",[s._v("使用php-resque单独启动worker处理进程在后台处理任务，参考"),e("a",{attrs:{href:"https://github.com/resque/php-resque#workers",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),e("OutboundLink")],1),s._v("，启动进程一条命令可以实现：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# QUEUE=default APP_INCLUDE=job.php REDIS_BACKEND=redis://:abc@127.0.0.1 php vendor/bin/resque \n[notice] Starting worker your_hostname:499:default\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("解释下，启动resque队列处理进程主要是靠vender/bin/resque，它运行时接收几个环境变量，参照上面的命令，环境变量有：")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("QUEUE - 必需，队列名，resque进程会处理哪些队列")])]),s._v(" "),e("li",[e("p",[s._v("APP_INCLUDE - 也是必需，引入任务类文件")])]),s._v(" "),e("li",[e("p",[s._v("REDIS_BACKEND - redis连接信息，可以使用DSN-style，默认localhost:6379")])])]),s._v(" "),e("p",[s._v("这命令会在前台启动，新开终端可以看到resque进程。")]),s._v(" "),e("p",[e("strong",[s._v("7.2.4 测试执行任务")])]),s._v(" "),e("p",[s._v("现在在新终端以cli方法执行index.php，会向default队列扔一个TestJob任务，然后worker检测到任务后会执行，worker那个终端会输出"),e("code",[s._v('"Hello saintic.com"')])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# QUEUE=default APP_INCLUDE=job.php REDIS_BACKEND=redis://:abc@127.0.0.1 php vendor/bin/resque \n[notice] Starting worker taochengwei:499:default\n[notice] Starting work on (Job{default} | ID: 71ef15f4246b450abe9fd6436758e73f | TestJob | [{"name":"saintic.com"}])\nHello saintic.com\n[notice] (Job{default} | ID: 71ef15f4246b450abe9fd6436758e73f | TestJob | [{"name":"saintic.com"}])\nhas finished\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("PS：以上输出内容我手动换行了。")]),s._v(" "),e("p",[s._v("当前demo目录文件结构如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# tree -L 1\n.\n├── composer.json\n├── composer.lock\n├── index.php\n├── job.php\n└── vendor\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("以上php-resque示例中，php版本7.2，操作系统Ubuntu 18.04.1 LTS")]),s._v(" "),e("p",[s._v("附录：一个启动、停止php-resque worker进程的脚本，"),e("a",{attrs:{href:"https://github.com/staugur/tdi-php/blob/master/src/online_rq.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("github这里"),e("OutboundLink")],1),s._v("，这个脚本中任务类文件写死是qf.php，供参考，自行修改哦。")]),s._v(" "),e("p",[s._v("注意：停止进程最好使用signals，参考"),e("a",{attrs:{href:"https://github.com/resque/php-resque#signals",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),e("OutboundLink")],1),s._v("，上面脚本用的是QUIT信号。")]),s._v(" "),e("h4",{attrs:{id:"end"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#end"}},[s._v("#")]),s._v(" END")])])}),[],!1,null,null,null);n.default=r.exports}}]);